<?php

namespace App\Http\Controllers\Admin\Api;

use App\Http\Controllers\Controller;
use App\Models\DonHang;
use App\Models\User;
use App\Models\VanChuyen;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Http;
use Illuminate\Support\Facades\Log;
use Telegram\Bot\Laravel\Facades\Telegram;



class ThongBaoTelegramController extends Controller
{
    // H√†m g·ª≠i th√¥ng b√°o qua Telegram khi c√≥ ƒë∆°n h√†ng m·ªõi cho t·∫•t c·∫£ shipper
    public function thongBaoDonHangMoi(Request $request)
    {
        $vanChuyen = VanChuyen::find($request->id_van_chuyen);

        if (!$vanChuyen) {
            return response()->json(['message' => 'Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng.'], 404);
        }

        $message = "üì¶ ƒê∆°n h√†ng m·ªõi ƒë√£ ƒë∆∞·ª£c giao cho b·∫°n!\n";
        $message .= "M√£ v·∫≠n chuy·ªÉn: {$vanChuyen->ma_van_chuyen}\n";
        $message .= "Tr·∫°ng th√°i: {$vanChuyen->trang_thai_van_chuyen}\n";
        $message .= "COD: {$vanChuyen->tien_cod} VND\n";
        $message .= "Ghi ch√∫: {$vanChuyen->ghi_chu}\n";

        $shippers = User::whereNotNull('so_dien_thoai')
            ->whereNotNull('telegram_chat_id')
            ->get();

        foreach ($shippers as $shipper) {
            $this->sendTelegramMessage($shipper->telegram_chat_id, $message);
        }

        return response()->json(['message' => 'Th√¥ng b√°o ƒë√£ ƒë∆∞·ª£c g·ª≠i t·ªõi t·∫•t c·∫£ shipper.']);
    }

    // H√†m th√¥ng b√°o khi ƒë∆°n h√†ng ho√†n t·∫•t
    public function thongBaoHoanTatDonHang(DonHang $donHang)
    {
        if ($donHang->trang_thai_don_hang === DonHang::TTDH_HTDH && $donHang->vanChuyen) {
            $message = "‚úÖ ƒê∆°n h√†ng {$donHang->ma_don_hang} ƒë√£ ho√†n t·∫•t th√†nh c√¥ng!\n";
            $message .= "Kh√°ch h√†ng: {$donHang->ten_nguoi_dat_hang}\n";
            $message .= "T·ªïng ti·ªÅn: {$donHang->tong_tien_don_hang} VND\n";

            $shipper = User::find($donHang->vanChuyen->shipper_id);

            if ($shipper && $shipper->telegram_chat_id) {
                $this->sendTelegramMessage($shipper->telegram_chat_id, $message);
            }

            return response()->json(['message' => 'Th√¥ng b√°o ho√†n t·∫•t ƒë∆°n h√†ng ƒë√£ ƒë∆∞·ª£c g·ª≠i.']);
        }

        return response()->json(['message' => 'Tr·∫°ng th√°i ƒë∆°n h√†ng kh√¥ng ph√π h·ª£p ho·∫∑c kh√¥ng c√≥ th√¥ng tin v·∫≠n chuy·ªÉn.'], 400);
    }

    // H√†m g·ª≠i tin nh·∫Øn qua Telegram
    private function sendTelegramMessage($chatId, $message)
    {
        $token = env('TELEGRAM_BOT_TOKEN');
        $url = "https://api.telegram.org/bot{$token}/sendMessage";

        $response = Http::post($url, [
            'chat_id' => $chatId,
            'text' => $message,
        ]);

        if ($response->successful()) {
            return $response->json();
        } else {
            // X·ª≠ l√Ω l·ªói khi g·ª≠i th·∫•t b·∫°i
            Log::error("G·ª≠i th√¥ng b√°o Telegram th·∫•t b·∫°i: " . $response->body());
            return ['error' => 'Kh√¥ng th·ªÉ g·ª≠i tin nh·∫Øn qua Telegram'];
        }
    }
}
