<?php

namespace App\Console\Commands;

use App\Models\ChuongTrinhUuDai;
use App\Models\ThongBao;
use App\Models\User;
use App\Models\VaiTro; // Đảm bảo import mô hình VaiTro
use App\Events\ThongBaoMoi;
use Illuminate\Console\Command;
use Carbon\Carbon;

class GuiThongBaoKhuyenMai extends Command
{
    protected $signature = 'chuongtrinh:guithongbao';
    protected $description = 'Gửi thông báo khi đến ngày bắt đầu hoặc ngày hiện của chương trình ưu đãi';

    public function handle()
    {
        $now = Carbon::now();

        $chuongTrinhUuDai = ChuongTrinhUuDai::where(function ($query) use ($now) {
            $query->whereDate('ngay_bat_dau', $now->toDateString())
                ->orWhereDate('ngay_hien_thi', $now->toDateString());
        })
            ->get();

        foreach ($chuongTrinhUuDai as $chuongTrinh) {
            $this->sendNotification(
                'Chương trình ưu đãi mới',
                "Chương trình ưu đãi '{$chuongTrinh->ten}' đã bắt đầu hoặc đến hạn vào ngày hôm nay!",
                '/chuong-trinh/' . $chuongTrinh->duong_dan
            );
        }

        $this->info('Thông báo chương trình ưu đãi đã được gửi.');
    }

    /**
     * Hàm hỗ trợ gửi thông báo cho người dùng
     */
    private function sendNotification($title, $content, $link)
    {
        // Chỉ lấy những người dùng có vai trò 'Khách hàng'
        $users = User::whereHas('vaiTros', function($query) {
            $query->where('vai_tros.ten', 'Khách hàng'); // Thay 'Khách hàng' bằng tên vai trò thực tế
        })->get();

        foreach ($users as $user) {
            $thongBao = ThongBao::create([
                'user_id' => $user->id,
                'tieu_de' => $title,
                'noi_dung' => $content,
                'loai' => 'uu_dai',
                'duong_dan' => $link,
                'trang_thai_da_doc' => 0
            ]);

            broadcast(new ThongBaoMoi($thongBao))->toOthers();
        }
    }
}
